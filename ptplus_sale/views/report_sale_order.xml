<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <!-- Sale Report is redefined: - use 'VAT %' instead of 'VAT id' in lines - AT mandatory text on
        customer docs -->
    <template
        id="report_saleorder_document"
        inherit_id="sale.report_saleorder_document"
    >
        <xpath expr="//t[@t-set='address']" position="after">
            <t
                t-if="doc.source_billing"
                t-set="pt_certification_text"
                t-value="doc.pt_get_certification_text()"
            />
        </xpath>

        <!-- Remove VAT from address -->
        <xpath expr="//t[@t-set='address']/p" position="attributes">
            <attribute name="t-if">not doc.source_billing</attribute>
        </xpath>

        <!-- Information zone fields -->
        <xpath expr="//div[@t-if='doc.client_order_ref']" position="before">
            <div
                t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2"
                t-if="doc.l10n_pt_date_issued"
            >
                <strong>Date:</strong>
                <br />
                <span t-field="doc.l10n_pt_date_issued" />
            </div>
        </xpath>
        <!-- Change text Quotation Date - Request Date -->
        <!-- Add partner VAT No. -->
        <xpath expr="//div[@name='informations_date']" position="attributes">
            <attribute name="t-if">not doc.source_billing</attribute>
        </xpath>
        <xpath expr="//div[@name='informations_date']" position="after">
            <div
                t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2"
                t-if="doc.source_billing and doc.date_order and doc.state in ['draft','sent']"
            >
                <strong>Request Date:</strong>
                <br />
                <span t-field="doc.date_order" t-options="{'widget': 'date'}" />
            </div>
            <div
                t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2"
                t-if="doc.source_billing and doc.partner_id.vat"
            >
                <strong><t
                    t-out="doc.company_id.country_id.vat_label or 'Tax ID'"
                />:</strong>
                <br />
                <span t-out="doc.partner_id.pt_get_vat()" />
            </div>
        </xpath>

        <xpath expr="//div[@id='informations']" position="inside">
            <div
                t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2"
                t-if="doc.source_billing and doc.l10n_pt_quotation_id"
            >
                <strong>Source Doc:</strong>
                <br />
                <span t-out="doc.l10n_pt_quotation_id.pt_get_no()" />
            </div>
        </xpath>

        <!-- Document Name -->
        <xpath expr="//t[@t-set='layout_document_title']" position="attributes">
            <attribute name="t-if">not doc.source_billing</attribute>
        </xpath>
        <xpath expr="//t[@t-set='layout_document_title']" position="after">
            <div t-if="doc.source_billing" class="row pt_doc_name">
                <div class="col-10">
                    <h2>
                        <span t-out="doc.pt_get_fullname()" />
                        <span
                            t-if="doc.state == 'cancel'"
                            t-field="doc.state"
                            class="pt_cancelled"
                        />
                    </h2>
                </div>
                <div class="col-2 text-right" style="padding-top: 3mm">
                    <span
                        t-if="multiway_tag"
                        class="pt_multiway_tag"
                        t-out="multiway_tag"
                    />
                </div>
            </div>
        </xpath>

        <!--Discounts-->
        <!--Remove negative lines from main table-->
        <xpath expr="//td[@name='td_name']/.." position="attributes">
            <attribute
                name="t-if"
            >not line.display_type and line.product_type != 'combo' and (not doc.source_billing or (doc.source_billing and line.price_subtotal &gt;= 0))</attribute>
        </xpath>

        <!--New summary table to display discounts-->
        <xpath expr="//t[@t-set='tax_totals']" position="before">
            <t t-if="doc.source_billing">
                <t t-set="amount_without_discount" t-value="0" />
                <t t-foreach="lines_to_report" t-as="discount_line">
                    <t t-if="discount_line.price_unit &gt;= 0">
                        <t
                            t-set="amount_without_discount"
                            t-value="amount_without_discount + discount_line.price_subtotal"
                        />
                    </t>
                </t>

                <tr
                    t-if="discount_line.price_subtotal &lt; 0"
                    class="border-black o_subtotal"
                >
                    <td>
                        <strong>Subtotal</strong>
                    </td>
                    <td class="text-end">
                        <span
                            t-out="amount_without_discount"
                            t-options='{"widget": "monetary", "display_currency": doc.currency_id}'
                        />
                    </td>
                </tr>

                <t t-foreach="lines_to_report" t-as="discount_line">
                    <t t-if="amount_without_discount &gt;= 0">
                        <tr>
                            <t t-if="discount_line.price_subtotal &lt; 0">
                                <td>
                                    <span t-esc="discount_line.name" />
                                    <t
                                        t-if="doc.source_billing and (doc.fiscal_document_type_id and doc.fiscal_document_type_id.type == 'PF')"
                                    >
                                        <span
                                            class="pt_vat_list"
                                            t-foreach="line.tax_id"
                                            t-as="tax"
                                        >
                                            <span
                                                class="pt_vat_exemption_reason"
                                                t-if="tax.pt_vat_exemption_reason"
                                                t-out="tax.pt_vat_exemption_reason"
                                            />
                                        </span>
                                    </t>
                                </td>
                                <td class="text-end o_price_total">
                                    <span
                                        class="text-nowrap"
                                        t-out="discount_line.price_subtotal"
                                        t-options='{"widget": "monetary", "display_currency": doc.currency_id}'
                                    />
                                </td>
                            </t>
                        </tr>
                    </t>
                </t>
            </t>
        </xpath>

        <!-- Order lines in PRO FORMA -->
        <xpath expr="//span[@t-out='taxes']" position="attributes">
            <attribute
                name="t-if"
            >not doc.source_billing or (doc.fiscal_document_type_id and doc.fiscal_document_type_id.type != "PF")</attribute>
        </xpath>
        <xpath expr="//span[@t-out='taxes']" position="after">
            <span t-else="" class="pt_vat_list" t-foreach="line.tax_id" t-as="tax">
                <span t-out="tax.invoice_label or tax.name" />
                <span
                    class="pt_vat_exemption_reason"
                    t-if="tax.pt_vat_exemption_reason"
                    t-out="tax.pt_vat_exemption_reason"
                />
            </span>
        </xpath>

        <!-- VAT Exemption Reasons and amount in EUR in PRO FORMA-->
        <xpath expr="//div[@name='so_total_summary']" position="after">
            <t
                t-set="exempt_taxes"
                t-value="lines_to_report.tax_id.filtered(lambda r: r.pt_vat_exemption_reason)"
            />
            <p
                class="pt_vat_exemption_reason_list"
                t-if="exempt_taxes and (doc.fiscal_document_type_id and doc.fiscal_document_type_id.type == 'PF')"
            >
                <t t-foreach="exempt_taxes" t-as="exempt_tax">
                    <span t-out="exempt_tax.pt_get_vat_exemption_reason_text()" />
                </t>
            </p>
        </xpath>

        <!-- A place for PT extras -->
        <xpath expr="//div[hasclass('page')]" position="inside">
            <t t-call="ptplus.pt_features_bottom" />
        </xpath>
    </template>
</odoo>
