<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <!-- Invoice document mods -->
    <template id="report_invoice_document" inherit_id="account.report_invoice_document">
        <!-- Certification Text-->
        <xpath expr="//t[@t-set='o']" position="after">
            <t
                t-if="o.source_billing"
                t-set="pt_certification_text"
                t-value="o.pt_get_certification_text()"
            />
        </xpath>

        <!-- Remove VAT from standard address -->
        <xpath
            expr="//t[@t-set='address']/div[@t-if='o.partner_id.vat']" position="attributes">
            <attribute name="t-att-style">'display: none;' if o.source_billing else ''</attribute>
        >
        </xpath>

        <!-- Information zone fields -->
        <xpath
            expr="//div[@id='informations']/div[@name='invoice_date']"
            position="replace"
        >
            <!-- Replace label Invoice Date with plain Date -->
            <div class="col-auto mw-100 mb-2" t-if="o.invoice_date" name="invoice_date">
                <strong>Date:</strong>
                <p class="m-0" t-field="o.invoice_date" />
            </div>
            <!-- Add Vat No. -->
            <div t-if="o.source_billing and o.partner_id.vat" class="col-auto mw-100 mb-2">
                <strong><t
                        t-out="o.company_id.country_id.vat_label or 'Tax ID'"
                    />:</strong>
                <p class="m-0" t-out="o.partner_id.pt_get_vat()" />
            </div>
        </xpath>

        <!-- Document Name -->
        <xpath expr="//h2" position="attributes">
            <attribute name="t-if">not o.source_billing</attribute>
        </xpath>
        <xpath expr="//h2" position="after">
            <div t-if="o.source_billing" class="row pt_doc_name">
                <div class="col-10">
                    <h2>
                        <span t-out="o.pt_get_fullname(lang=o.partner_id.lang)" />
                        <span
                            t-if="o.state == 'cancel'"
                            t-field="o.state"
                            class="pt_cancelled"
                        />
                    </h2>
                </div>
                <div
                    t-if="multiway_tag"
                    class="col-2 text-right"
                    style="padding-top: 3mm"
                >
                    <span class="pt_multiway_tag" t-out="multiway_tag" />
                </div>
            </div>
        </xpath>

        <!-- Invoice lines -->
        <xpath expr="//span[@id='line_tax_ids']" position="attributes">
            <attribute name="t-if">not o.source_billing</attribute>
        </xpath>
        <xpath expr="//span[@id='line_tax_ids']" position="after">
            <span t-else="" class="pt_vat_list" t-foreach="line.tax_ids" t-as="tax">
                <span t-out="tax.description or tax.name" />
                <span
                    class="pt_vat_exemption_reason"
                    t-if="tax.pt_vat_exemption_reason"
                    t-out="tax.pt_vat_exemption_reason"
                />
            </span>
        </xpath>

        <!-- Tax column is right aligned -->
        <xpath expr="//th[@name='th_taxes']" position="attributes">
            <attribute
                name="t-attf-class"
            >text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}</attribute>
        </xpath>
        <xpath expr="//tbody/t/tr/t/td[5]" position="attributes">
            <attribute
                name="t-attf-class"
            >text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}</attribute>
        </xpath>

        <!-- VAT Exemption Reasons and amount in EUR -->
        <xpath expr="//p[@name='payment_communication']" position="before">
            <t
                t-set="exempt_taxes"
                t-value="o.mapped('invoice_line_ids.tax_ids').filtered(lambda r: r.pt_vat_exemption_reason)"
            />
            <p class="pt_vat_exemption_reason_list" t-if="exempt_taxes">
                <t t-foreach="exempt_taxes" t-as="exempt_tax">
                    <span t-out="exempt_tax.pt_get_vat_exemption_reason_text()" />
                </t>
            </p>
            <div id="company_currency_total" t-if="o.source_billing and o.currency_id != o.company_currency_id">
                <t
                    t-set="doc_totals"
                    t-value="o.l10n_pt_get_document_totals()"
                />
                <span>Total in EUR: </span>
                <span
                    t-out="doc_totals[2]"
                    t-options='{"widget": "monetary", "display_currency": o.company_currency_id}'
                />
            </div>
        </xpath>

        <!-- A place for PT extras -->
        <xpath expr="//div[hasclass('page')]" position="inside">
            <p t-if="o.l10n_pt_company_show_goods_provision">
                The invoiced goods/services were made available to the purchaser
                <span t-if="o.l10n_pt_goods_provision_date">on <span t-field="o.l10n_pt_goods_provision_date"/></span>
                <span t-else="">on the document date</span>
                <span>(Alínea f do nº 5 do Artº 36 CIVA)</span>
            </p>
            <t t-call="ptplus.pt_features_bottom" />
        </xpath>

    </template>

    <!--Handle withholding taxes-->
    <template id="tax_groups_totals" inherit_id="account.tax_groups_totals">
        <!-- Ensure we only modify behavior when not in source billing mode -->
        <xpath expr="//t[@t-as='amount_by_group']" position="before">
            <t t-set="o" t-value="o or doc or sale_order or order" />
            <t t-set="source_billing" t-value="o.source_billing if o._name in ['account.move', 'sale.order'] else False" />
        </xpath>
        <xpath expr="//t[@t-as='amount_by_group']" position="attributes">
            <attribute name="t-foreach">not source_billing and tax_totals['groups_by_subtotal'][subtotal_to_show]</attribute>
        </xpath>

        <!-- Pre-process taxes into retention and other categories -->
        <xpath expr="//t[@t-as='amount_by_group']" position="after">
            <t t-set="retention_taxes" t-value="[]"/>
            <t t-set="other_taxes" t-value="[]"/>
            <t t-foreach="source_billing and tax_totals['groups_by_subtotal'][subtotal_to_show]" t-as="amount_by_group">
                <t t-if="amount_by_group.get('l10n_pt_genre') == 'RF'">
                    <t t-set="retention_taxes" t-value="retention_taxes + [amount_by_group]"/>
                </t>
                <t t-else="">
                    <t t-set="other_taxes" t-value="other_taxes + [amount_by_group]"/>
                </t>
            </t>

            <!-- Display other taxes first -->
            <t t-foreach="other_taxes" t-as="amount_by_group">
                <tr>
                    <t t-if="len(tax_totals['groups_by_subtotal'][subtotal_to_show]) > 1 or (tax_totals['amount_untaxed'] != amount_by_group['tax_group_base_amount'])">
                        <td>
                            <span t-esc="amount_by_group['tax_group_name']"/>
                            <span class="text-nowrap">
                                on <t t-esc="amount_by_group['formatted_tax_group_base_amount']"/>
                            </span>
                        </td>
                        <td class="text-right o_price_total">
                            <span class="text-nowrap" t-esc="amount_by_group['formatted_tax_group_amount']"/>
                        </td>
                    </t>
                    <t t-else="">
                        <td><span class="text-nowrap" t-esc="amount_by_group['tax_group_name']"/></td>
                        <td class="text-right o_price_total">
                            <span class="text-nowrap" t-esc="amount_by_group['formatted_tax_group_amount']"/>
                        </td>
                    </t>
                </tr>
            </t>

            <!-- Summarize total excluding retention taxes -->
            <tr t-if="retention_taxes" class="border-black o_subtotal">
                <td><strong>Total</strong></td>
                <td class="text-right o_price_total">
                    <span class="text-nowrap" t-esc="tax_totals['l10n_formatted_total_excluding_retention']"/>
                </td>
            </tr>

            <!-- Then, list retention taxes -->
            <t t-foreach="retention_taxes" t-as="amount_by_group">
                <tr>
                    <t t-if="len(tax_totals['groups_by_subtotal'][subtotal_to_show]) > 1 or (tax_totals['amount_untaxed'] != amount_by_group['tax_group_base_amount'])">
                        <td>
                            <span t-esc="amount_by_group['tax_group_name']"/>
                            <span class="text-nowrap">
                                on <t t-esc="amount_by_group['formatted_tax_group_base_amount']"/>
                            </span>
                        </td>
                        <td class="text-right o_price_total">
                            <span class="text-nowrap" t-esc="amount_by_group['formatted_tax_group_amount']"/>
                        </td>
                    </t>
                    <t t-else="">
                        <td><span class="text-nowrap" t-esc="amount_by_group['tax_group_name']"/></td>
                        <td class="text-right o_price_total">
                            <span class="text-nowrap" t-esc="amount_by_group['formatted_tax_group_amount']"/>
                        </td>
                    </t>
                </tr>
            </t>
        </xpath>
    </template>

    <template id="document_tax_totals" inherit_id="account.document_tax_totals">
        <xpath expr="//tr[hasclass('o_total')]" position="before">
            <t t-set="o" t-value="o or doc or sale_order or order" />
            <t t-set="source_billing" t-value="o.source_billing if o._name in ['account.move', 'sale.order'] else False" />
            <t t-set="retention_taxes" t-value="[]"/>
            <t t-foreach="tax_totals['groups_by_subtotal'][subtotal_to_show]" t-as="amount_by_group">
                <t t-if="amount_by_group.get('l10n_pt_genre') == 'RF'">
                    <t t-set="retention_taxes" t-value="retention_taxes + [amount_by_group]"/>
                </t>
            </t>
        </xpath>
        <xpath expr="//tr[hasclass('o_total')]//td" position="attributes">
            <attribute name="t-if">not source_billing</attribute>
        </xpath>
        <xpath expr="//tr[hasclass('o_total')]//td" position="after">
            <td t-elif="source_billing and retention_taxes"><strong>Total to Pay</strong></td>
            <td t-else=""><strong>Total</strong></td>
        </xpath>
    </template>

</odoo>
